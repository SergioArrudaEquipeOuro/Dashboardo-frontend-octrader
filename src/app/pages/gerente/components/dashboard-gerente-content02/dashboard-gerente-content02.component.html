<div class="user-list">
    <h3>Lista de Releases</h3>

    <div class="filter-section">
        <div class="row g-2 filter-group">
            <!-- Busca livre -->
            <div class="col-12 col-md-6 col-lg-5">
                <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()" class="form-control"
                    placeholder="Buscar por tipo, status, email, moeda..." />
            </div>

            <!-- Filtro status -->
            <div class="col-6 col-md-3 col-lg-2">
                <select class="form-select" [(ngModel)]="statusFilter" (change)="onSearchChange()">
                    <option value="">Status (todos)</option>
                    <option value="PENDING">PENDING</option>
                    <option value="APPROVED">APPROVED</option>
                    <option value="REFUSED">REFUSED</option>
                </select>
            </div>

            <!-- Filtro tipo -->
            <div class="col-6 col-md-3 col-lg-2">
                <select class="form-select" [(ngModel)]="entryTypeFilter" (change)="onSearchChange()">
                    <option value="">Tipo (todos)</option>
                    <option value="DEPOSIT">DEPOSIT</option>
                    <option value="WITHDRAWAL">WITHDRAWAL</option>
                    <option value="CREDIT">CREDIT</option>
                    <option value="LOAN">LOAN</option>
                    <option value="CREDITWITHDRAWA">CREDITWITHDRAWA</option>
                    <option value="LOANWITHDRAWA">LOANWITHDRAWA</option>
                    <option value="TRANSFER">TRANSFER</option>
                </select>
            </div>

            <!-- Botão carregar -->
            <div class="col-12 col-lg-3 d-grid">
                <button type="button" class="btn btn-secondary" (click)="reload()">Carregar</button>
            </div>
        </div>
    </div>

    <ng-template #loadingTpl>
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    </ng-template>

    <div *ngIf="!loading; else loadingTpl">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-header">
                    <tr>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Cliente (email)</th>
                        <th>Status</th>
                        <th>Valor</th>
                        <th class="d-none d-lg-table-cell">Moeda</th>
                        <th class="d-none d-xl-table-cell">Transf.</th>
                        <th>Data</th>
                        <th class="d-none d-xl-table-cell">Visível</th>
                        <th class="d-none d-xl-table-cell">Fake</th>
                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody>
                    <tr *ngFor="let r of pagedReleases()">
                        <td data-label="ID">{{ r.id }}</td>

                        <td class="text-start" data-label="Tipo">
                            <i class="bi entry-icon"
                                [ngClass]="[ iconFor(r.entryType), colorFor(r.entryType, r.status) ]"
                                [attr.title]="r.entryType + ' — ' + r.status" aria-hidden="true"></i>
                            <span class="text">{{ r.entryType }}</span>
                        </td>

                        <td class="nowrap" data-label="Cliente (email)">{{ r.email }}</td>

                        <td class="text-start" data-label="Status">
                            <i class="bi status-icon" [ngClass]="{
                'bi-check-circle-fill text-success': r.status === 'APPROVED',
                'bi-hourglass-split text-warning': r.status === 'PENDING',
                'bi-x-circle-fill text-danger': r.status === 'REFUSED'
              }" [attr.title]="r.status" [attr.aria-label]="r.status"></i>
                            <span class="text">{{ r.status }}</span>
                        </td>

                        <td data-label="Valor">{{ r.value | currency }}</td>
                        <td class="d-none d-lg-table-cell" data-label="Moeda">{{ r.coin }}</td>
                        <td class="d-none d-xl-table-cell" data-label="Transf.">{{ r.typeTransfer || '—' }}</td>
                        <td data-label="Data">{{ r.date | date:'dd/MM/yyyy' }}</td>

                        <td class="d-none d-xl-table-cell" data-label="Visível">
                            <span class="badge"
                                [ngClass]="r.visibily ? 'bg-success' : (r.visibily === false ? 'bg-secondary' : 'bg-light text-muted')">
                                {{ r.visibily === true ? 'Sim' : r.visibily === false ? 'Não' : '—' }}
                            </span>
                        </td>

                        <td class="d-none d-xl-table-cell" data-label="Fake">
                            <span class="badge"
                                [ngClass]="r.fk ? 'bg-primary' : (r.fk === false ? 'bg-secondary' : 'bg-light text-muted')">
                                {{ r.fk === true ? 'Fake' : r.fk === false ? 'Real' : '—' }}
                            </span>
                        </td>

                        <td class="text-nowrap" data-label="Ações">
                            <div class="btn-group w-100 w-sm-auto">
                                <button class="btn btn-primary btn-sm dropdown-toggle w-100 w-sm-auto"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Ações
                                </button>

                                <ul class="dropdown-menu dropdown-menu-end w-100 w-sm-auto">
                                    <li *ngIf="r.status === 'PENDING' && canApproveRelease(r)">
                                        <button class="dropdown-item" (click)="approve(r)">Aprovar</button>
                                    </li>

                                    <li *ngIf="r.status === 'PENDING' && canRejectRelease(r)">
                                        <button class="dropdown-item" (click)="reject(r)">Reprovar</button>
                                    </li>
                                    <li *ngIf="canDeleteRelease(r)">
                                        <!-- <hr class="dropdown-divider"> -->
                                        <button class="dropdown-item text-danger" (click)="delete(r)">Deletar</button>
                                    </li>
                                </ul>
                            </div>
                        </td>

                    </tr>

                    <tr *ngIf="releases?.length === 0">
                        <td colspan="12" class="text-center text-muted">Nenhum release encontrado.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginação -->
        <nav *ngIf="totalPages > 1" aria-label="Page navigation" class="paginator">
            <ul class="pagination justify-content-center flex-wrap">
                <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link" (click)="changePage(currentPage - 1)" aria-label="Anterior">«</button>
                </li>

                <li class="page-item" *ngFor="let p of pages" [class.active]="p === currentPage"
                    [class.disabled]="p === '...'">
                    <button class="page-link" (click)="p !== '...' && changePage(p)">{{ p }}</button>
                </li>

                <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <button class="page-link" (click)="changePage(currentPage + 1)" aria-label="Próxima">»</button>
                </li>
            </ul>
            <div class="page-info text-center">Página {{ currentPage }} de {{ totalPages }}</div>
        </nav>
    </div>
</div>