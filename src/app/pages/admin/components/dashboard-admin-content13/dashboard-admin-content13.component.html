<!-- PAGE -->
<div class="page" (click)="onRootClick()">
    <div class="toolbar">
        <div class="title">
            <h2>Históricos</h2>
            <div class="counters">
                <span class="chip">Total: <strong>{{ total }}</strong></span>
                <span class="chip alt">Filtrados: <strong>{{ filtrados }}</strong></span>
                <span class="chip alt" *ngIf="filtrados > 0">
                    Página: <strong>{{ paginaAtual }}</strong>/<strong>{{ totalPaginas }}</strong>
                </span>
            </div>
        </div>

        <div class="actions">
            <div class="segmented" role="tablist" aria-label="Alternar visualização">
                <button type="button" class="seg-btn" [class.active]="viewMode === 'cards'"
                    [attr.aria-selected]="viewMode === 'cards'" aria-controls="timeline-view"
                    (click)="alternarView('cards')">
                    Linha do tempo
                </button>
                <button type="button" class="seg-btn" [class.active]="viewMode === 'table'"
                    [attr.aria-selected]="viewMode === 'table'" aria-controls="table-view"
                    (click)="alternarView('table')">
                    Tabela
                </button>
            </div>
            <button type="button" class="btn ghost" (click)="atualizar()">Atualizar</button>
        </div>
    </div>

    <!-- FILTROS -->
    <form [formGroup]="form" class="filter-card" (click)="$event.stopPropagation()" novalidate>
        <div class="grid">
            <label class="field">
                <span>Busca livre</span>
                <input formControlName="buscaLivre" placeholder="Título, assunto, autor, emails, obs..." />
            </label>

            <label class="field">
                <span>Título</span>
                <select formControlName="titulo">
                    <option value="">Todos</option>
                    <option *ngFor="let t of uniqueTitulos" [value]="t">{{ t }}</option>
                </select>
            </label>

            <label class="field">
                <span>Assunto</span>
                <select formControlName="assunto">
                    <option value="">Todos</option>
                    <option *ngFor="let a of uniqueAssuntos" [value]="a">{{ a }}</option>
                </select>
            </label>

            <label class="field">
                <span>Autor</span>
                <input formControlName="autor" placeholder="Autor" />
            </label>

            <label class="field">
                <span>Email Cliente</span>
                <input formControlName="emailCliente" placeholder="cliente@exemplo.com" />
            </label>

            <label class="field">
                <span>Email Broker</span>
                <input formControlName="emailBrokere" placeholder="broker@exemplo.com" />
            </label>

            <label class="field">
                <span>Visibilidade</span>
                <select formControlName="visibily">
                    <option value="any">Qualquer</option>
                    <option [value]="true">Visível</option>
                    <option [value]="false">Oculto</option>
                </select>
            </label>

            <label class="field">
                <span>Notificação</span>
                <select formControlName="visibilyNotificacao">
                    <option value="any">Qualquer</option>
                    <option [value]="true">Ativa</option>
                    <option [value]="false">Inativa</option>
                </select>
            </label>

            <label class="field">
                <span>Ordenar por data</span>
                <select formControlName="ordenarPorDataDesc">
                    <option [ngValue]="true">Mais novo no topo</option>
                    <option [ngValue]="false">Mais antigo no topo</option>
                </select>
            </label>
        </div>

        <div class="filter-actions">
            <button type="button" class="btn subtle" (click)="limparFiltros()">Limpar filtros</button>
        </div>
    </form>

    <!-- CHIPS DE FILTROS ATIVOS -->
    <div class="active-filters" *ngIf="activeFilterChips.length">
        <span class="chip outline" *ngFor="let chip of activeFilterChips; trackBy: trackByChip">{{ chip }}</span>
    </div>

    <!-- STATES -->
    <div *ngIf="loading" class="state info" role="status" aria-live="polite">
        <div class="spinner"></div>
        <span>Carregando históricos...</span>
    </div>

    <div *ngIf="!loading && error" class="state danger" role="alert">
        {{ error }}
    </div>

    <div *ngIf="!loading && !error && historicosFiltrados.length === 0" class="state muted">
        Nenhum histórico encontrado com os filtros atuais.
    </div>

    <!-- PAGINADOR (TOPO) -->
    <div class="paginator" *ngIf="!loading && !error && filtrados > 0">
        <div class="range">
            Mostrando <strong>{{ inicioPagina + 1 }}</strong>–<strong>{{ fimPagina }}</strong> de <strong>{{ filtrados
                }}</strong>
        </div>
        <div class="page-controls" role="navigation" aria-label="Paginação">
            <button class="btn btn-sm" (click)="firstPage()" [disabled]="paginaAtual === 1"
                aria-label="Primeira página">«</button>
            <button class="btn btn-sm" (click)="prevPage()" [disabled]="paginaAtual === 1"
                aria-label="Página anterior">‹</button>
            <span class="page-indicator">Página {{ paginaAtual }} / {{ totalPaginas }}</span>
            <button class="btn btn-sm" (click)="nextPage()" [disabled]="paginaAtual === totalPaginas"
                aria-label="Próxima página">›</button>
            <button class="btn btn-sm" (click)="lastPage()" [disabled]="paginaAtual === totalPaginas"
                aria-label="Última página">»</button>
        </div>
    </div>

    <!-- TIMELINE (cards) -->
    <ul *ngIf="!loading && !error && viewMode === 'cards'" id="timeline-view" class="timeline"
        (click)="$event.stopPropagation()">
        <li *ngFor="let h of paginaHistoricos; trackBy: trackById" class="tl-item">
            <span class="dot" [class.ok]="h.visibily" [class.warn]="h.visibilyNotificacao && !h.visibily"
                [class.off]="!h.visibily && !h.visibilyNotificacao"></span>

            <article class="card">
                <header class="card-head">
                    <h3 class="card-title">
                        ID#{{h.id}} - {{h.date | date:"dd/MM/yyyy":'UTC'}} - {{ h.titulo || 'Sem título' }}
                    </h3>

                    <div class="card-actions">
                        <time class="date-badge">{{ h.date | date:'short' }}</time>

                        <div class="actions-inline" (click)="$event.stopPropagation()" *ngIf="user.email === 'ROOT'">
                            <button type="button" class="btn btn-sm" (click)="toggleRowMenu(h.id!)"
                                [attr.aria-expanded]="rowMenuOpenId === h.id">
                                Ações ▾
                            </button>

                            <div class="row-menu" *ngIf="rowMenuOpenId === h.id">
                                <!-- EDITAR via Bootstrap Modal -->
                                <button type="button" class="row-menu-item" (click)="openEdit(h)" data-bs-toggle="modal"
                                    data-bs-target="#editModal">
                                    Editar
                                </button>

                                <!-- DELETAR via Bootstrap Modal -->
                                <button type="button" class="row-menu-item danger" (click)="openDelete(h)"
                                    data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    Deletar
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <section class="meta">
                    <div class="meta-col">
                        <span class="label">Assunto</span>
                        <p>{{ h.assunto || '—' }}</p>
                    </div>

                    <div class="meta-col">
                        <span class="label">Autor</span>
                        <p>{{ h.autor || '—' }}</p>
                    </div>

                    <div class="meta-col">
                        <span class="label">Email Cliente</span>
                        <p>{{ h.emailCliente || '—' }}</p>
                    </div>

                    <div class="meta-col">
                        <span class="label">Email Broker</span>
                        <p>{{ h.emailBrokere || '—' }}</p>
                    </div>

                    <div class="meta-col span-2">
                        <span class="label">Obs</span>
                        <p>{{ h.obs || '—' }}</p>
                    </div>

                    <div class="meta-col">
                        <span class="label">Visível</span>
                        <span class="badge" [class.badge-ok]="h.visibily === true"
                            [class.badge-off]="h.visibily === false">
                            {{ h.visibily === true ? 'Sim' : h.visibily === false ? 'Não' : '—' }}
                        </span>
                    </div>

                    <div class="meta-col">
                        <span class="label">Notificação</span>
                        <span class="badge" [class.badge-ok]="h.visibilyNotificacao === true"
                            [class.badge-off]="h.visibilyNotificacao === false">
                            {{ h.visibilyNotificacao === true ? 'Ativa' : h.visibilyNotificacao === false ? 'Inativa' :
                            '—' }}
                        </span>
                    </div>

                    <div class="meta-col">
                        <span class="label">ID</span>
                        <p>#{{ h.id ?? '—' }}</p>
                    </div>
                </section>
            </article>
        </li>
    </ul>

    <!-- TABELA -->
    <div *ngIf="!loading && !error && viewMode === 'table'" id="table-view" class="table-card"
        (click)="$event.stopPropagation()">
        <div class="table-scroller">
            <table class="table">
                <thead>
                    <tr>
                        <th class="right">ID</th>
                        <th>Título</th>
                        <th>Assunto</th>
                        <th>Autor</th>
                        <th>Email Cliente</th>
                        <th>Email Broker</th>
                        <th>Visível</th>
                        <th>Notificação</th>
                        <th>Data</th>
                        <th class="center actions-col" *ngIf="user.email === 'ROOT'">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let h of paginaHistoricos; trackBy: trackById">
                        <td class="right">#{{ h.id }}</td>
                        <td class="truncate" title="{{ h.titulo }}">{{ h.titulo }}</td>
                        <td class="truncate" title="{{ h.assunto }}">{{ h.assunto }}</td>
                        <td class="truncate" title="{{ h.autor }}">{{ h.autor }}</td>
                        <td class="truncate" title="{{ h.emailCliente }}">{{ h.emailCliente }}</td>
                        <td class="truncate" title="{{ h.emailBrokere }}">{{ h.emailBrokere }}</td>
                        <td>
                            <span class="badge" [class.badge-ok]="h.visibily === true"
                                [class.badge-off]="h.visibily === false">
                                {{ h.visibily === true ? 'Sim' : h.visibily === false ? 'Não' : '—' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge" [class.badge-ok]="h.visibilyNotificacao === true"
                                [class.badge-off]="h.visibilyNotificacao === false">
                                {{ h.visibilyNotificacao === true ? 'Ativa' : h.visibilyNotificacao === false ?
                                'Inativa' : '—' }}
                            </span>
                        </td>
                        <td>{{ h.date | date:'short' }}</td>
                        <td class="center actions-cell" *ngIf="user.email === 'ROOT'">
                            <button type="button" class="btn btn-sm"
                                (click)="toggleRowMenu(h.id!); $event.stopPropagation()"
                                [attr.aria-expanded]="rowMenuOpenId === h.id">
                                Ações ▾
                            </button>

                            <div class="row-menu" *ngIf="rowMenuOpenId === h.id">
                                <button type="button" class="row-menu-item" (click)="openEdit(h)" data-bs-toggle="modal"
                                    data-bs-target="#editModal">
                                    Editar
                                </button>
                                <button type="button" class="row-menu-item danger" (click)="openDelete(h)"
                                    data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    Deletar
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAGINADOR (BASE) -->
    <div class="paginator bottom" *ngIf="!loading && !error && filtrados > 0">
        <div class="range">
            Mostrando <strong>{{ inicioPagina + 1 }}</strong>–<strong>{{ fimPagina }}</strong> de <strong>{{ filtrados
                }}</strong>
        </div>
        <div class="page-controls" role="navigation" aria-label="Paginação">
            <button class="btn btn-sm" (click)="firstPage()" [disabled]="paginaAtual === 1"
                aria-label="Primeira página">«</button>
            <button class="btn btn-sm" (click)="prevPage()" [disabled]="paginaAtual === 1"
                aria-label="Página anterior">‹</button>
            <span class="page-indicator">Página {{ paginaAtual }} / {{ totalPaginas }}</span>
            <button class="btn btn-sm" (click)="nextPage()" [disabled]="paginaAtual === totalPaginas"
                aria-label="Próxima página">›</button>
            <button class="btn btn-sm" (click)="lastPage()" [disabled]="paginaAtual === totalPaginas"
                aria-label="Última página">»</button>
        </div>
    </div>
</div>

<!-- ======= BOOTSTRAP MODALS (fora da .page) ======= -->

<!-- EDIT MODAL (Bootstrap) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar histórico #{{ editTarget?.id }}</h3>
                <button type="button" class="btn-close" aria-label="Fechar" data-bs-dismiss="modal"
                    (click)="closeEdit()"></button>
            </div>

            <div class="modal-body">
                <form [formGroup]="editForm" novalidate>
                    <div class="grid-2">
                        <label class="field">
                            <span>Título</span>
                            <input class="form-control" formControlName="titulo" />
                        </label>
                        <label class="field">
                            <span>Assunto</span>
                            <input class="form-control" formControlName="assunto" />
                        </label>
                        <label class="field">
                            <span>Autor</span>
                            <input class="form-control" formControlName="autor" />
                        </label>
                        <label class="field">
                            <span>Email Cliente</span>
                            <input class="form-control" formControlName="emailCliente" />
                        </label>
                        <label class="field">
                            <span>Email Broker</span>
                            <input class="form-control" formControlName="emailBrokere" />
                        </label>
                        <label class="field">
                            <span>Visível</span>
                            <select class="form-select" formControlName="visibily">
                                <option [ngValue]="true">Sim</option>
                                <option [ngValue]="false">Não</option>
                            </select>
                        </label>
                        <label class="field">
                            <span>Notificação</span>
                            <select class="form-select" formControlName="visibilyNotificacao">
                                <option [ngValue]="true">Ativa</option>
                                <option [ngValue]="false">Inativa</option>
                            </select>
                        </label>
                        <label class="field">
                            <span>Data (ISO)</span>
                            <input class="form-control" formControlName="date" placeholder="2025-08-27T12:34:56Z" />
                        </label>
                        <label class="field span-2">
                            <span>Obs</span>
                            <textarea class="form-control" formControlName="obs" rows="4"></textarea>
                        </label>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn ghost" data-bs-dismiss="modal" (click)="closeEdit()">Cancelar</button>
                <button type="button" class="btn" [disabled]="editSaving || !editForm" (click)="saveEdit()"
                    data-bs-dismiss="modal">
                    <span *ngIf="!editSaving">Salvar</span>
                    <span *ngIf="editSaving" class="inline-spinner"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- DELETE MODAL (Bootstrap) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Deletar histórico #{{ deleteTarget?.id }}</h3>
                <button type="button" class="btn-close" aria-label="Fechar" data-bs-dismiss="modal"
                    (click)="closeDelete()"></button>
            </div>

            <div class="modal-body">
                <p>Para confirmar a exclusão, digite <strong>delete</strong> no campo abaixo.</p>
                <input class="form-control confirm-input" [(ngModel)]="deletePassword" placeholder="digite: delete" />
                <p *ngIf="deleteError" class="error-text">{{ deleteError }}</p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn ghost" data-bs-dismiss="modal"
                    (click)="closeDelete()">Cancelar</button>
                <button type="button" class="btn danger" [disabled]="deletePassword !== 'delete'"
                    (click)="confirmDelete()" data-bs-dismiss="modal">
                    Deletar
                </button>
            </div>
        </div>
    </div>
</div>