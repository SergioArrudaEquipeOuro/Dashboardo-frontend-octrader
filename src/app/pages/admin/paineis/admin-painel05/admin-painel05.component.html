<form (ngSubmit)="submit()" novalidate>
    <!-- Identificação do ativo (inputs desabilitados) -->
    <div class="row g-3 mb-1">
        <div class="col-12 col-md-4">
            <label class="form-label">Direção do mercado</label>
            <input type="text" class="form-control" [value]="direcaoMercado" disabled />
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">Símbolo</label>
            <input type="text" class="form-control mono" [value]="symbol" disabled />
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">Nome do ativo</label>
            <input type="text" class="form-control" [value]="nomeAtivo" disabled />
        </div>
    </div>

    <!-- Seleção de cliente (apenas ROOT/ADMINISTRADOR/BROKER) -->
    <div class="mt-3" *ngIf="allowedToPickClients; else clienteSomenteLeitura">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div class="me-auto">
                <label class="form-label mb-1">Selecionar cliente</label>
                <div class="form-text">
                    Filtre por <strong>nome</strong> ou <strong>email</strong> e clique em <em>Selecionar</em>.
                </div>
            </div>
            <div class="client-search">
                <input type="text" class="form-control" placeholder="Filtrar clientes por nome ou email"
                    [(ngModel)]="clientQuery" name="clientQuery" (input)="applyClientFilterAndPaging()"
                    autocomplete="off" />
            </div>
        </div>

        <div class="client-table-wrap">
            <table class="table table-sm table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Saldo</th>
                        <th>Crédito</th>
                        <th>Empréstimo</th>
                        <th style="width: 140px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let c of clientRows; trackBy: trackClient"
                        [class.table-active]="selectedCliente?.id === c.id">
                        <td>{{ c.id }}</td>
                        <td>{{ c.nome ?? c.name ?? '—' }}</td>
                        <td class="mono">{{ c.email ?? '—' }}</td>
                        <td>{{ c.saldo | currency}}</td>
                        <td>{{ c.credito | currency }}</td>
                        <td>{{ c.emprestimo | currency }}</td>
                        <td>
                            <button type="button" class="btn btn-outline-primary btn-sm" (click)="selectClient(c)"
                                [disabled]="selectedCliente?.id === c.id">
                                {{ selectedCliente?.id === c.id ? 'Selecionado' : 'Selecionar' }}
                            </button>
                        </td>
                    </tr>

                    <tr *ngIf="clientTotal === 0">
                        <td colspan="4" class="text-center text-muted py-3">Nenhum cliente encontrado.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Info seleção + Limpar -->
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div class="small text-muted">
                <ng-container *ngIf="selectedCliente; else noSel">
                    Selecionado:
                    <strong>{{ selectedCliente?.nome ?? selectedCliente?.name ?? '—' }}</strong>
                    <span class="mono">&lt;{{ selectedCliente?.email }}&gt;</span>
                    • ID <strong>{{ selectedCliente?.id }}</strong>
                </ng-container>
                <ng-template #noSel> Nenhum cliente selecionado. </ng-template>
            </div>

            <button type="button" class="btn btn-link p-0" (click)="clearSelectedClient()"
                [disabled]="!selectedCliente">
                Limpar seleção
            </button>
        </div>

        <!-- Paginator de clientes -->
        <div class="paginator" *ngIf="clientTotalPages > 1">
            <button class="btn btn-sm btn-light me-1" (click)="goToClientPage(1)"
                [disabled]="clientPage === 1">«</button>
            <button class="btn btn-sm btn-light me-1" (click)="prevClientPage()"
                [disabled]="clientPage === 1">‹</button>

            <ng-container *ngFor="let p of clientPageList()">
                <button *ngIf="p !== '…'; else dotsC" class="btn btn-sm btn-light me-1"
                    [class.active]="p === clientPage" (click)="goToClientPage(p)">
                    {{ p }}
                </button>
                <ng-template #dotsC><span class="dots">…</span></ng-template>
            </ng-container>

            <button class="btn btn-sm btn-light me-1" (click)="nextClientPage()"
                [disabled]="clientPage === clientTotalPages">
                ›
            </button>
            <button class="btn btn-sm btn-light" (click)="goToClientPage(clientTotalPages)"
                [disabled]="clientPage === clientTotalPages">
                »
            </button>
        </div>
    </div>

    <!-- Cliente apenas leitura / fallback -->
    <ng-template #clienteSomenteLeitura>
        <div class="row g-3 mt-1">
            <div class="col-12 col-md-6">
                <label class="form-label">Cliente (ID)</label>
                <input type="text" class="form-control" [value]="fallbackClienteId != null ? fallbackClienteId : '—'"
                    disabled />
                <div class="form-text">Detectado do usuário logado.</div>
            </div>
        </div>
    </ng-template>

    <hr class="my-3" />

    <!-- Restante do formulário do Bot -->
    <div class="row g-3">
        <div class="col-12 col-md-6">
            <label class="form-label">KeyPass (obrigatório)</label>
            <input type="text" class="form-control" [(ngModel)]="codKeyPass" name="codKeyPass" required
                placeholder="Ex.: KP-123-XYZ" />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Estratégia</label>
            <select class="form-select" [(ngModel)]="profile" name="profile">
                <option *ngFor="let p of profiles" [ngValue]="p.value">{{ p.label }}</option>
            </select>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Tipo de stop</label>
            <select class="form-select" [(ngModel)]="stopType" name="stopType">
                <option *ngFor="let t of stopTypes" [ngValue]="t.value">{{ t.label }}</option>
            </select>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Volume</label>
            <input type="number" class="form-control" [(ngModel)]="volume" name="volume" min="0" step="any" required />
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label">Stop Win</label>
            <input type="number" class="form-control" [(ngModel)]="stopWin" name="stopWin" step="any" required />
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label">Stop Loss</label>
            <input type="number" class="form-control" [(ngModel)]="stopLoss" name="stopLoss" step="any" required />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Saldo a alocar</label>
            <div class="input-group">
                <span class="input-group-text">R$</span>
                <input type="number" class="form-control" [(ngModel)]="saldo" name="saldo" min="0" step="any"
                    required />
            </div>
            <div class="form-text">Montante que será debitado do cliente conforme ordem do KeyPass.</div>
        </div>
    </div>

    <div class="mt-3" *ngIf="errorMsg">
        <div class="alert alert-danger py-2">{{ errorMsg }}</div>
    </div>
    <div class="mt-3" *ngIf="successMsg">
        <div class="alert alert-success py-2">{{ successMsg }}</div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" [disabled]="loading">
            Cancelar
        </button>
        <button type="submit" class="btn btn-success fw-bold" [disabled]="!canSubmit()">
            <span *ngIf="!loading">Criar bot</span>
            <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span *ngIf="loading" class="ms-2">Criando…</span>
        </button>
    </div>
</form>