<div class="hb-wrap">
    <div class="hb-top px-3 py-2 d-flex justify-content-between align-items-center sticky-top">
        <h5 class="m-0">Histórico de Bots</h5>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary hb-btn" (click)="load()">
                <span class="me-1" *ngIf="!loading">Recarregar</span>
                <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="hb-filter px-3 py-2">
        <div class="filter-grid">
            <select class="form-select form-select-sm filter-select" [(ngModel)]="filterType">
                <option value="broker">Broker (e-mail)</option>
                <option value="idBot">ID do Bot</option>
                <option value="idUsuario">ID do Cliente</option>
                <option value="tokenBot">Token do Bot</option>
            </select>

            <input class="form-control form-control-sm filter-input" type="text" [(ngModel)]="query"
                (keydown.enter)="applyFilter()" [placeholder]="placeholderFor(filterType)" />

            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-primary" (click)="applyFilter()">Filtrar</button>
                <button class="btn btn-sm btn-outline-secondary hb-btn" (click)="clearFilter()">Limpar</button>
            </div>
        </div>
        <div class="filter-hint" *ngIf="query">
            Filtrando por <strong>{{ labelFor(filterType) }}</strong>: <span class="mono">{{ query }}</span>
        </div>
    </div>

    <div *ngIf="errorMsg" class="alert alert-danger m-3">{{ errorMsg }}</div>

    <div *ngIf="loading && !errorMsg" class="p-4 text-center">
        <div class="spinner-border" role="status"></div>
        <div class="mt-2">Carregando…</div>
    </div>

    <div *ngIf="!loading && !errorMsg && (!historicos || !historicos.length)" class="p-4 text-center text-muted">
        Nenhum histórico encontrado.
    </div>

    <div class="cards-grid">
        <article class="hb-card" *ngFor="let h of historicos">
            <header class="hb-head">
                <div class="left">
                    <span class="chip mono">#{{ h.id }}</span>
                    <span class="chip mono">{{ h.tokenBot || '—' }}</span>
                    <span *ngIf="h.status" class="status" [class.ok]="h.status==='FINISHED'">{{ h.status }}</span>
                </div>
                <div class="right mono">
                    <small class="text-muted">Criado em</small>
                    <strong class="ms-1">{{ h.date | date:'dd/MM/yyyy HH:mm' }}</strong>
                </div>
            </header>

            <section class="cols">
                <!-- Identificação -->
                <div class="panel">
                    <h6>Identificação</h6>
                    <dl class="kv">
                        <div class="kv-row">
                            <dt>Bot ID</dt>
                            <dd class="mono">{{ h.idBot ?? '—' }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Usuário (ID)</dt>
                            <dd class="mono">{{ h.idUsuario ?? '—' }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Broker</dt>
                            <dd>{{ h.broker || '—' }}</dd>
                        </div>
                    </dl>
                </div>

                <!-- Configuração -->
                <div class="panel">
                    <h6>Configuração do bot</h6>
                    <dl class="kv">
                        <div class="kv-row">
                            <dt>Projeção</dt>
                            <dd class="mono">
                                {{ h.projecaoBot!==undefined ? (h.projecaoBot | number:'1.2-2') + '%' : '—' }}
                            </dd>
                        </div>
                        <div class="kv-row">
                            <dt>Período</dt>
                            <dd class="mono">
                                {{ h.dataInicioBot ? (h.dataInicioBot | date:'dd/MM/yyyy':'America/Sao_Paulo') :
                                '—' }}
                                →
                                {{ h.dataFimBot ? (h.dataFimBot | date:'dd/MM/yyyy':'America/Sao_Paulo') : '—' }}
                            </dd>
                        </div>

                        <div class="kv-row">
                            <dt>Saldo inicial</dt>
                            <dd class="mono">{{ h.saldoInicialBot | currency }}</dd>
                        </div>
                    </dl>
                </div>

                <!-- Saldos (criação) -->
                <div class="panel">
                    <h6>Criação do bot</h6>
                    <dl class="kv">
                        <div class="kv-row">
                            <dt>Saldo (antes)</dt>
                            <dd class="mono">{{ h.saldoUsuarioAntesDoBotCreate | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Crédito (antes)</dt>
                            <dd class="mono">{{ h.creditoUsuarioAntesDoBotCreate | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Empréstimo (antes)</dt>
                            <dd class="mono">{{ h.emprestimoUsuarioAntesDoBotCreate | currency }}</dd>
                        </div>
                        <div class="kv-row divider"></div>
                        <div class="kv-row">
                            <dt>Saldo (depois)</dt>
                            <dd class="mono">{{ h.saldoUsuarioDepoisDoBotCreate | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Crédito (depois)</dt>
                            <dd class="mono">{{ h.creditoUsuarioDepoisDoBotCreate | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Empréstimo (depois)</dt>
                            <dd class="mono">{{ h.emprestimoUsuarioDepoisDoBotCreate | currency }}</dd>
                        </div>
                    </dl>
                </div>

                <!-- Finalização -->
                <div class="panel" *ngIf="hasFinishBlock(h)">
                    <h6>Finalização do bot</h6>
                    <dl class="kv">
                        <div class="kv-row">
                            <dt>Status</dt>
                            <dd class="mono">{{ h.status || '—' }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Finalizado em</dt>
                            <dd class="mono">{{ h.dateFinalizacao | date:'dd/MM/yyyy HH:mm' }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Saldo final</dt>
                            <dd class="mono">{{ h.saldoFinalBot | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Lucro</dt>
                            <dd class="mono">
                                <span [class.pos]="(h.lucro||0)>=0" [class.neg]="(h.lucro||0)<0">
                                    {{ h.lucro | currency }}
                                </span>
                            </dd>
                        </div>
                        <div class="kv-row">
                            <dt>Operações</dt>
                            <dd class="mono">{{ h.operacoesLength ?? '—' }}</dd>
                        </div>
                    </dl>
                </div>

                <!-- Saldos (finalização) -->
                <div class="panel" *ngIf="hasFinishBlock(h)">
                    <h6>Cliente na finalização</h6>
                    <dl class="kv">
                        <div class="kv-row">
                            <dt>Saldo (antes)</dt>
                            <dd class="mono">{{ h.saldoUsuarioAntesDoBotFinish | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Crédito (antes)</dt>
                            <dd class="mono">{{ h.creditoUsuarioAntesDoBotFinish | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Empréstimo (antes)</dt>
                            <dd class="mono">{{ h.emprestimoUsuarioAntesDoBotFinish | currency }}</dd>
                        </div>
                        <div class="kv-row divider"></div>
                        <div class="kv-row">
                            <dt>Saldo (depois)</dt>
                            <dd class="mono">{{ h.saldoUsuarioDepoisDoBotFinish | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Crédito (depois)</dt>
                            <dd class="mono">{{ h.creditoUsuarioDepoisDoBotFinish | currency }}</dd>
                        </div>
                        <div class="kv-row">
                            <dt>Empréstimo (depois)</dt>
                            <dd class="mono">{{ h.emprestimoUsuarioDepoisDoBotFinish | currency }}</dd>
                        </div>
                    </dl>
                </div>
            </section>
        </article>
    </div>
</div>