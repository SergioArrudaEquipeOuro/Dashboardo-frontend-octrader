<div class="release-form-container release-card">
    <div class="header-line fancy">
        <div class="title-wrap">
            <i class="bi bi-lightning-charge-fill"></i>
            <h5 class="mb-0">Novo release</h5>
        </div>
        <small class="text-muted">
            <i class="bi bi-person-badge me-1"></i> Usuário alvo: #{{ userId }}
        </small>
    </div>

    <div *ngIf="successMsg" class="alert alert-success py-2 my-3">
        <i class="bi bi-check-circle me-2"></i>{{ successMsg }}
    </div>
    <div *ngIf="errorMsg" class="alert alert-danger py-2 my-3">
        <i class="bi bi-exclamation-octagon me-2"></i>{{ errorMsg }}
    </div>

    <form [formGroup]="form" (ngSubmit)="submit()" class="mt-3">
        <div class="row g-3">

            <!-- entryType -->
            <div class="col-md-6">
                <label class="form-label">
                    <i class="bi bi-diagram-3 me-1"></i> Tipo (entryType) *
                </label>
                <div class="input-group icon-input">
                    <span class="input-group-text"
                        [ngClass]="entryTypePillClass(form.value.entryType, form.value.status)">
                        <i [class]="'bi ' + entryTypeIcon(form.value.entryType)"></i>
                    </span>
                    <select class="form-select" formControlName="entryType" (change)="onEntryTypeChange()">
                        <option [ngValue]="null" disabled>Selecione...</option>
                        <option [ngValue]="'DEPOSIT'">Depósito</option>
                        <option [ngValue]="'WITHDRAWAL'">Saque</option>
                        <option [ngValue]="'CREDIT'">Crédito</option>
                        <option [ngValue]="'LOAN'">Empréstimo</option>
                        <option [ngValue]="'CREDITWITHDRAWA'">Saída de crédito</option>
                        <option [ngValue]="'LOANWITHDRAWA'">Saída de empréstimo</option>
                        <option [ngValue]="'TRANSFER'">Transferência</option>
                    </select>
                </div>
                <div class="invalid" *ngIf="f['entryType'].touched && f['entryType'].invalid">Obrigatório.</div>
            </div>

            <!-- status -->
            <div class="col-md-6">
                <label class="form-label">
                    <i class="bi bi-flag me-1"></i> Status
                </label>
                <div class="input-group icon-input">
                    <span class="input-group-text" [ngClass]="statusPillClass(form.value.status)">
                        <i [class]="'bi ' + statusIcon(form.value.status)"></i>
                    </span>
                    <select class="form-select" formControlName="status">
                        <option *ngFor="let s of statusOptions" [ngValue]="s">{{ s }}</option>
                    </select>
                </div>
                <div class="hint"><i class="bi bi-info-circle me-1"></i> Se não souber, deixe em
                    <strong>PENDING</strong>.</div>
            </div>

            <!-- value -->
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-cash-coin me-1"></i> Valor *</label>
                <div class="input-group icon-input">
                    <span class="input-group-text"><i class="bi bi-currency-exchange"></i></span>
                    <input type="text" class="form-control" formControlName="value" placeholder="Ex: 1000,00"
                        inputmode="decimal" />
                </div>
                <div class="invalid" *ngIf="f['value'].touched && f['value'].errors?.['required']">Obrigatório.</div>
                <div class="invalid" *ngIf="f['value'].touched && f['value'].errors?.['min']">O valor deve ser maior que
                    zero.</div>
            </div>

            <!-- coin -->
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-coin me-1"></i> Moeda (coin) *</label>
                <div class="input-group icon-input">
                    <span class="input-group-text"><i class="bi bi-cash-stack"></i></span>
                    <select class="form-select" formControlName="coin">
                        <option *ngFor="let c of coins" [ngValue]="c">{{ c }}</option>
                    </select>
                </div>
            </div>

            <!-- typeTransfer -->
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-arrow-left-right me-1"></i> Tipo de transferência
                    (typeTransfer)</label>
                <div class="input-group icon-input">
                    <span class="input-group-text"><i class="bi bi-shuffle"></i></span>
                    <select class="form-select" formControlName="typeTransfer">
                        <option value="">—</option>
                        <option *ngFor="let tt of transferTypes" [ngValue]="tt">{{ tt }}</option>
                    </select>
                </div>
                <div class="invalid"
                    *ngIf="transferTypeRequired && f['typeTransfer'].touched && f['typeTransfer'].invalid">
                    Obrigatório quando entryType = TRANSFER.
                </div>
            </div>

            <!-- date -->
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-calendar-event me-1"></i> Data</label>
                <div class="input-group icon-input">
                    <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                    <input type="date" class="form-control" formControlName="date" />
                </div>
                <div class="invalid" *ngIf="f['date'].touched && f['date'].invalid">Obrigatória.</div>
                <div class="hint"><i class="bi bi-info-circle me-1"></i> Se mudar, enviaremos essa data (UTC 00:00) para
                    o backend.</div>
            </div>

            <!-- proof -->
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-link-45deg me-1"></i> Comprovante (proof)</label>
                <div class="input-group icon-input">
                    <span class="input-group-text"><i class="bi bi-receipt"></i></span>
                    <input type="text" class="form-control" formControlName="proof"
                        placeholder="URL / código / referência" />
                </div>
            </div>

            <!-- visibily -->
            <div class="col-md-6">
                <label class="form-label d-block"><i class="bi bi-eye me-1"></i> Visibilidade para o cliente
                    (visibily)</label>
                <div class="switch-row">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="visibilySwitch" formControlName="visibily"
                            [checked]="f['visibily'].value === true"
                            (change)="f['visibily'].setValue($any($event.target).checked ? true : false)" />
                    </div>
                    <span class="chip" [ngClass]="{
            'chip-on': f['visibily'].value === true,
            'chip-off': f['visibily'].value === false
          }">
                        <i class="bi" [class.bi-eye]="f['visibily'].value === true"
                            [class.bi-eye-slash]="f['visibily'].value === false"></i>
                        {{ f['visibily'].value === true ? 'Visível' : f['visibily'].value === false ? 'Oculto' : 'Não
                        definido' }}
                    </span>
                </div>
            </div>

            <!-- fk -->
            <div class="col-md-6">
                <label class="form-label d-block"><i class="bi bi-magic me-1"></i> Valor fake (fk)</label>
                <div class="switch-row">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="fkSwitch" formControlName="fk"
                            [checked]="f['fk'].value === true"
                            (change)="f['fk'].setValue($any($event.target).checked ? true : false)" />
                    </div>
                    <span class="chip" [ngClass]="{
            'chip-on': f['fk'].value === true,
            'chip-off': f['fk'].value === false
          }">
                        <i class="bi" [class.bi-stars]="f['fk'].value === true"
                            [class.bi-check2-circle]="f['fk'].value === false"></i>
                        {{ f['fk'].value === true ? 'Fake ativo' : f['fk'].value === false ? 'Real' : 'Não definido' }}
                    </span>
                </div>
            </div>

            <!-- observacoes -->
            <div class="col-12">
                <label class="form-label"><i class="bi bi-chat-left-dots me-1"></i> Observações</label>
                <div class="textarea-wrap">
                    <i class="bi bi-journal-text left"></i>
                    <textarea class="form-control" rows="3" formControlName="observacoes"
                        placeholder="Notas internas..."></textarea>
                </div>
            </div>

        </div>

        <div class="d-flex gap-2 justify-content-end mt-4">
            <button type="button" class="btn btn-outline-secondary" (click)="clear()" [disabled]="saving">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Limpar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="saving || form.invalid">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status"
                    aria-hidden="true"></span>
                <i class="bi bi-clipboard-check me-1" *ngIf="!saving"></i>
                Revisar e criar
            </button>
        </div>

        <div class="mt-3 hint">
            <ul class="mb-0 nice-list">
                <li><i class="bi bi-shield-exclamation me-2"></i> Saques (WITHDRAWAL) criados ficam <em>PENDING</em> e
                    debitam o saldo do cliente na criação.</li>
                <li><i class="bi bi-shield-exclamation me-2"></i> Não é permitido criar um novo WITHDRAWAL se já existir
                    um PENDING.</li>
                <li><i class="bi bi-shield-exclamation me-2"></i> TRANSFER exige saldo suficiente e é aprovado/reprovado
                    conforme validação do backend.</li>
            </ul>
        </div>
    </form>
</div>

<!-- ===== Modal de confirmação ===== -->
<div class="modal-backdrop fade show" *ngIf="showConfirmModal" (click)="closeConfirm()"></div>
<div class="modal fancy-modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true" *ngIf="showConfirmModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header gradient">
                <h5 class="modal-title mb-0">
                    <i class="bi bi-clipboard2-check me-2"></i> Confirmar criação do release
                </h5>
                <button type="button" class="btn-close" (click)="closeConfirm()" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-diagram-3 me-1"></i> Tipo</span>
                        <div class="value">
                            <span class="pill" [ngClass]="entryTypePillClass(form.value.entryType, form.value.status)">
                                <i [class]="'bi ' + entryTypeIcon(form.value.entryType)"></i>
                                {{ form.value.entryType || '—' }}
                            </span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-flag me-1"></i> Status</span>
                        <div class="value">
                            <span class="pill" [ngClass]="statusPillClass(form.value.status)">
                                <i [class]="'bi ' + statusIcon(form.value.status)"></i>
                                {{ form.value.status || '—' }}
                            </span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-currency-exchange me-1"></i> Valor</span>
                        <div class="value">{{ (parseNumber(form.value.value) ?? 0) | number:'1.2-2' }} {{
                            form.value.coin }}</div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-coin me-1"></i> Moeda</span>
                        <div class="value">{{ form.value.coin || '—' }}</div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-shuffle me-1"></i> Tipo de transferência</span>
                        <div class="value">{{ form.value.typeTransfer || '—' }}</div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-calendar-event me-1"></i> Data</span>
                        <div class="value">
                            {{ ((form.value.date ? (form.value.date + 'T00:00:00Z') : null) | date:'dd/MM/yyyy') || '—'
                            }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-receipt me-1"></i> Comprovante</span>
                        <div class="value">{{ form.value.proof || '—' }}</div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-eye me-1"></i> Visível ao cliente</span>
                        <div class="value">{{ prettyTri(form.value.visibily) }}</div>
                    </div>

                    <div class="col-md-6">
                        <span class="label"><i class="bi bi-magic me-1"></i> Fake</span>
                        <div class="value">{{ prettyTri(form.value.fk) }}</div>
                    </div>

                    <div class="col-12">
                        <span class="label"><i class="bi bi-chat-left-dots me-1"></i> Observações</span>
                        <div class="value note-box">{{ form.value.observacoes || '—' }}</div>
                    </div>
                </div>

                <div class="alert alert-warning mt-3 mb-0" *ngIf="transferTypeRequired && !form.value.typeTransfer">
                    <i class="bi bi-exclamation-triangle me-2"></i> Para TRANSFER é obrigatório informar
                    <strong>typeTransfer</strong>.
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-secondary" (click)="closeConfirm()" [disabled]="saving">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </button>
                <button class="btn btn-primary" (click)="confirmCreate()"
                    [disabled]="saving || (transferTypeRequired && !form.value.typeTransfer)">
                    <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                    <i class="bi bi-send-check me-1" *ngIf="!saving"></i>
                    Confirmar e criar
                </button>
            </div>
        </div>
    </div>
</div>