<div class="shell">
    <header class="hero">
        <div class="hero__title">
            <h2>UTIP Trades</h2>
            <p class="muted">{{ filteredTrades.length }} resultado(s)</p>
        </div>

        <div class="filters">
            <!-- Email -->
            <label class="fld">
                <span>Email do cliente</span>
                <input class="inp" type="search" placeholder="ex: alice@dominio.com" [(ngModel)]="filterEmail"
                    (ngModelChange)="onFilterChange()" />
            </label>

            <!-- Tipo -->
            <label class="fld">
                <span>Tipo</span>
                <select class="inp" [(ngModel)]="filterType" (change)="onFilterChange()">
                    <option value="ALL">Todos</option>
                    <option value="BUY">BUY</option>
                    <option value="SELL">SELL</option>
                </select>
            </label>

            <!-- Status -->
            <label class="fld">
                <span>Status</span>
                <select class="inp" [(ngModel)]="filterStatus" (change)="onFilterChange()">
                    <option value="ALL">Todos</option>
                    <option value="OPEN">Open</option>
                    <option value="CLOSE">Close</option>
                </select>
            </label>

            <!-- Direção / Categoria -->
            <label class="fld">
                <span>Direção</span>
                <select class="inp" [(ngModel)]="filterCategory" (change)="onFilterChange()">
                    <option value="ALL">Todas</option>
                    <option value="forex">Forex</option>
                    <option value="indices">Índices</option>
                    <option value="commodities">Commodities</option>
                    <option value="crypto">Cripto</option>
                    <option value="stocks">Ações</option>
                </select>
            </label>

            <!-- Ações -->
            <div class="filters__actions">
                <button class="btn ghost" type="button" (click)="clearFilters()">Limpar</button>
                <button class="btn primary" type="button" (click)="loadAllForBroker(user.id)" [disabled]="loading">
                    <i class="fa fa-refresh"></i>&nbsp;{{ loading ? 'Recarregando…' : 'Recarregar' }}
                </button>
            </div>
        </div>
    </header>

    <!-- Tabela -->
    <section class="card">
        <div class="datawrap" [class.loading]="loading">
            <table class="grid-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>DEMO</th>
                        <th>Cliente</th>
                        <th>Direção</th>
                        <th class="col-symbol">Symbol</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th class="right">Volume</th>
                        <th>Open</th>
                        <th>Close</th>
                        <th class="right">Px(Open)</th>
                        <th class="right">Px(Close)</th>
                        <th class="right">Px(Now)</th>
                        <th class="right">TP</th>
                        <th class="right">SL</th>
                        <th class="right">Commission</th>
                        <th class="right">Swap</th>
                        <th class="right">Lucro</th>
                        <th class="right">Profit</th>
                        <th class="col-closetype">ClosingType</th>
                        <th class="right" *ngIf="user.role === 'ROOT' || user.role === 'ADMINISTRADOR'"></th>
                    </tr>
                </thead>

                <tbody>
                    <ng-template #dash>—</ng-template>

                    <tr *ngFor="let t of filteredTrades; trackBy: trackByTrade" (click)="openEdit(t)" class="trow">

                        <td class="mono">{{ t.id }}</td>
                        <td class="mono">
                            <span [ngClass]="t.demo ? 'flag-demo' : 'flag-real'">
                                {{ t.demo ? 'DEMO' : 'REAL' }}
                            </span>
                        </td>

                        <td class="mono">{{ t.clienteEmail }}</td>

                        <td>
                            <span class="chip" [class.fx]="(t.marketCategory || categoryForTrade(t))==='forex'"
                                [class.idx]="(t.marketCategory || categoryForTrade(t))==='indices'"
                                [class.cmd]="(t.marketCategory || categoryForTrade(t))==='commodities'"
                                [class.cry]="(t.marketCategory || categoryForTrade(t))==='crypto'"
                                [class.stk]="(t.marketCategory || categoryForTrade(t))==='stocks'">
                                {{ t.marketCategory || categoryForTrade(t) }}
                            </span>
                        </td>

                        <td class="mono">{{ t.symbol }}</td>

                        <td>
                            <span class="chip" [class.buy]="(t.operationType||'').toUpperCase()==='BUY'"
                                [class.sell]="(t.operationType||'').toUpperCase()==='SELL'">
                                {{ t.operationType }}
                            </span>
                        </td>

                        <td>
                            <span class="chip" [class.open]="(t.status||'').toUpperCase()==='OPEN'"
                                [class.close]="(t.status||'').toUpperCase()==='CLOSE'">
                                {{ t.status }}
                            </span>
                        </td>

                        <td class="mono right">{{ t.volume }}</td>
                        <td class="mono">{{ t.openDate }} {{ t.openTime }}</td>
                        <td class="mono">{{ t.closeDate }} {{ t.closeTime }}</td>
                        <td class="mono right">{{ t.openPrice }}</td>
                        <td class="mono right">{{ t.closePrice }}</td>

                        <!-- Px(Now) com spinner até chegar o valor -->
                        <td class="mono right">
                            <ng-container *ngIf="livePriceFor(t) === null; else pxNowVal">
                                <span class="cellspin" aria-label="Carregando preço atual"></span>
                            </ng-container>
                            <ng-template #pxNowVal>
                                <span class="px-now" [ngClass]="priceChangeClass(t)">
                                    {{ livePriceFor(t)! | number:'1.2-6' }}
                                </span>
                            </ng-template>
                        </td>

                        <td class="mono right">{{ t.takeProfit }}</td>
                        <td class="mono right">{{ t.stopLoss }}</td>
                        <td class="mono right">{{ t.commission }}</td>
                        <td class="mono right">{{ t.swap }}</td>

                        <!-- LUCRO com spinner até calcular -->
                        <td class="mono right">
                            <ng-container *ngIf="profitValue(t) === null; else lucroVal">
                                <span class="cellspin" aria-label="Calculando lucro"></span>
                            </ng-container>
                            <ng-template #lucroVal>
                                <span [ngClass]="profitClass(t)">
                                    {{ profitValue(t)! | number:'1.2-6' }}
                                </span>
                            </ng-template>
                        </td>

                        <!-- Profit persistido no backend -->
                        <td class="mono right">
                            <ng-container *ngIf="(t.profit ?? t.profitCalculated) != null; else dash">
                                {{ (t.profit ?? t.profitCalculated)! | number:'1.2-6' }}
                            </ng-container>
                        </td>

                        <td class="mono">{{ t.closingType }}</td>

                        <td class="right actions-cell" (click)="$event.stopPropagation()"
                            *ngIf="user.role === 'ROOT' || user.role === 'ADMINISTRADOR'">
                            <div class="actions" [class.open]="rowMenuOpen===t.id">
                                <button type="button" class="btn sm action-toggle" (click)="toggleRowMenu(t.id, $event)"
                                    [attr.aria-expanded]="rowMenuOpen===t.id">
                                    Ações
                                    <i class="fa" [class.fa-chevron-down]="rowMenuOpen!==t.id"
                                        [class.fa-chevron-up]="rowMenuOpen===t.id"></i>
                                </button>

                                <div class="actions__menu" *ngIf="rowMenuOpen===t.id"
                                    (click)="$event.stopPropagation()">
                                    <button type="button" class="btn sm danger" (click)="onCloseTrade(t)"
                                        [disabled]="!t.id || (t.status || '').toUpperCase() === 'CLOSE' || isClosing(t.id!)"
                                        [title]="(t.status || '').toUpperCase() === 'CLOSE' ? 'Operação já encerrada' : 'Encerrar operação'">
                                        {{ (t.status || '').toUpperCase() === 'CLOSE'
                                        ? 'Fechada'
                                        : (isClosing(t.id!) ? 'Fechando...' : 'Fechar') }}
                                    </button>

                                    <button class="btn sm" (click)="openEdit(t)">Editar</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="overlay" *ngIf="loading">
                <div class="spinner"></div>
                <div>Carregando…</div>
            </div>
        </div>
    </section>
</div>

<!-- MODAL -->
<div class="backdrop" *ngIf="editOpen" (click)="closeEdit()"></div>
<div class="sheet" *ngIf="editOpen" role="dialog" aria-modal="true">
    <header class="sheet__hd">
        <strong>#{{ edit?.id }} — {{ edit?.symbol }}<div class="profit-amount"
                [ngClass]="editPnl == null ? '' : (editPnl > 0 ? 'pnl-positive' : (editPnl < 0 ? 'pnl-negative' : ''))">
                <ng-container *ngIf="editPnl !== null; else pnlLoading">
                    {{ editPnl | number:'1.2-6' }}
                </ng-container>
                <ng-template #pnlLoading>
                    <span class="cellspin" aria-label="Calculando lucro"></span>
                </ng-template>
            </div></strong>
        <button class="btn-icon" (click)="closeEdit()"><i class="fa fa-times"></i></button>
    </header>

    <div class="sheet__bd" *ngIf="edit">
        <div class="sheet__left">
            <div class="tvbox">
                <div id="tv_admin_trade" class="tv"></div>
            </div>
        </div>

        <div class="sheet__right">
            <div class="profit-callout" *ngIf="edit">
                <div class="profit-label">Lucro (simulação)</div>



                <div class="profit-hint">Atualiza ao digitar o <strong>Close price</strong>.</div>
            </div>

            <form (ngSubmit)="saveEdit()" #f="ngForm" class="form">
                <div class="grid">
                    <label>Cliente (email)
                        <input class="inp" [(ngModel)]="edit.clienteEmail" name="clienteEmail" />
                    </label>

                    <label>Symbol
                        <input class="inp" [(ngModel)]="edit.symbol" name="symbol" (ngModelChange)="onSymbolChange()" />
                    </label>

                    <label>Status
                        <select class="inp" [(ngModel)]="edit.status" name="status">
                            <option *ngFor="let v of statusTypes" [value]="v">{{ v }}</option>
                        </select>
                    </label>

                    <label>Operation
                        <select class="inp" [(ngModel)]="edit.operationType" name="operationType">
                            <option *ngFor="let v of opTypes" [value]="v">{{ v }}</option>
                        </select>
                    </label>

                    <label>Volume
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.volume" name="volume" />
                    </label>

                    <label>Swap
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.swap" name="swap" />
                    </label>

                    <label>Commission
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.commission"
                            name="commission" />
                    </label>

                    <label>Closing type
                        <select class="inp" [(ngModel)]="edit.closingType" name="closingType">
                            <option *ngFor="let v of closingTypes" [value]="v">{{ v || '—' }}</option>
                        </select>
                    </label>

                    <label>Open date
                        <input class="inp" type="date" [(ngModel)]="edit.openDate" name="openDate" />
                    </label>

                    <label>Open time
                        <input class="inp" type="time" step="1" [(ngModel)]="edit.openTime" name="openTime" />
                    </label>

                    <label>Open price
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.openPrice"
                            name="openPrice" />
                    </label>

                    <label>Close date
                        <input class="inp" type="date" [(ngModel)]="edit.closeDate" name="closeDate" />
                    </label>

                    <label>Close time
                        <input class="inp" type="time" step="1" [(ngModel)]="edit.closeTime" name="closeTime" />
                    </label>

                    <label>Close price
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.closePrice" name="closePrice"
                            (ngModelChange)="recalcEditPnl()" />
                    </label>

                    <label>LUCRO
                        <div class="profit-amount"
                            [ngClass]="editPnl == null ? '' : (editPnl > 0 ? 'pnl-positive' : (editPnl < 0 ? 'pnl-negative' : ''))">
                            <ng-container *ngIf="editPnl !== null; else pnlLoading">
                                {{ editPnl | number:'1.2-6' }}
                            </ng-container>
                            <ng-template #pnlLoading>
                                <span class="cellspin" aria-label="Calculando lucro"></span>
                            </ng-template>
                        </div>
                    </label>


                    <label>Take profit
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.takeProfit"
                            name="takeProfit" />
                    </label>

                    <label>Stop loss
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.stopLoss" name="stopLoss" />
                    </label>

                    <label>Creation close price
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.creationClosePrice"
                            name="creationClosePrice" />
                    </label>

                    <label>Day close quote
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.dayCloseQuote"
                            name="dayCloseQuote" />
                    </label>

                    <label>Profit
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.profit" name="profit" />
                    </label>

                    <label>Profit calculated
                        <input class="inp" type="number" step="0.000001" [(ngModel)]="edit.profitCalculated"
                            name="profitCalculated" />
                    </label>

                    <label>Created at
                        <input class="inp" type="text" [value]="edit.createdAt" disabled />
                    </label>

                    <label>Updated at
                        <input class="inp" type="text" [value]="edit.updatedAt" disabled />
                    </label>
                </div>

                <footer class="sheet__ft">
                    <button type="button" class="btn ghost" (click)="closeEdit()">Cancelar</button>
                    <button type="submit" class="btn primary" [disabled]="saving">
                        {{ saving ? 'Salvando…' : 'Salvar' }}
                    </button>
                </footer>
            </form>
        </div>
    </div>
</div>